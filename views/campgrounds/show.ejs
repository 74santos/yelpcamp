
<% layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/stylesheets/stars.css">


<div class="container my-5">
<div class="row justify-content-center">
<div class="col-md-5">  




  <div class="card shadow-lg  rounded-3">

    <div id="campgroundCarousel" class="carousel slide" data-bs-ride="carousel">

      <div class="carousel-inner  card-img-top  rounded-top-3">
        
        <% campground.images.forEach((img ,imgID) => { %>
        <div class="carousel-item <%= imgID === 0 ? 'active' : '' %>">
          <img class="d-block w-100" src="<%= img.url %>"  alt="<%= campground.title %>">
        </div>
        <% }) %>
  
      </div>

      <% if (campground.images.length > 1) { %>
      <a class="carousel-control-prev" href="#campgroundCarousel" role="button" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <!-- <span class="sr-only">Previous</span> -->
      </a>
      <a class="carousel-control-next" href="#campgroundCarousel" role="button" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <!-- <span class="sr-only">Next</span> -->
      </a>
      <% } %>
    </div>

   <!-- <% for( let img of campground.images) { %>
      <img src="<%= img.url %>" class="card-img-top  rounded-top-3" alt="<%= campground.title %>">
   <% } %> -->
   
    <div class="card-body">
      <h3 class="card-title"><%= campground.title %></h3>
      <h6 class="card-subtitle mb-2 text-muted"><i class="bi bi-pin-map-fill me-2"></i><%= campground.location %></h6>

      <% if (campground.author) { %>
        <small>Listed by <%= campground.author.username %></small>
      <% } else { %>
        <small class="text-muted">Author unknown</small>
      <% } %>

      <p class="card-text mt-3"><%= campground.description %></p>

      <% if (campground.price) { %>
        <p class="fw-bold"><i class="bi bi-currency-dollar"></i><%= campground.price %>/night</p>
      <% } %>


      <% if (currentUser && campground.author && currentUser._id.toString() === campground.author._id.toString()) { %>
      <div class="d-flex gap-2 mt-4">
        <a href="/campgrounds/<%= campground._id %>/edit" class="btn btn-outline-primary">
          <i class="bi bi-pencil-square"></i> Edit
        </a>

        <form action="/campgrounds/<%= campground._id %>?_method=DELETE" method="POST">
          <button class="btn btn-outline-danger" onclick="return confirm('Are you sure you want to delete this campground?')">
            <i class="bi bi-trash"></i> Delete
          </button>
        </form>
      </div>
      <% } %>


    </div>

    <div class="card-footer text-left bg-light mt-4  rounded-bottom-3">
      <a href="/campgrounds" class="btn btn-secondary">
        <i class="bi bi-arrow-left-circle"></i> Back to Campgrounds
      </a>
    </div>


  </div>

</div>

<div class="col-md-5  bg-light p-3 rounded">  

  <div id="map" style="height:200px;" class="mb-4 rounded"></div>
<% if (currentUser) { %>
<div class="mt-2">
  <h5 >How Was Your Campground Stay?</h5>
  
  <form action="/campgrounds/<%= campground._id %>/reviews" method="POST" class="needs-validation" novalidate>
    
    <!-- Rating -->
    <fieldset class="starability-basic" aria-label="First rating:">
      <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating." />
      <input type="radio" id="rate1" name="review[rating]" value="1" />
      <label for="rate1" title="Terrible"></label>
      <input type="radio" id="rate2" name="review[rating]" value="2" />
      <label for="rate2" title="Not good"></label>
      <input type="radio" id="rate3" name="review[rating]" value="3" />
      <label for="rate3" title="Average"></label>
      <input type="radio" id="rate4" name="review[rating]" value="4" />
      <label for="rate4" title="Very good"></label>
      <input type="radio" id="rate5" name="review[rating]" value="5" />
      <label for="rate5" title="Amazing"></label>
    </fieldset>
    

    <!-- Review Body -->
    <div class="my-3">
    
      <textarea 
        name="review[body]" 
        id="body"
        class="form-control" 
        rows="3" 
        placeholder="What did you enjoy or dislike?"
        required
      ></textarea>
      <div class="valid-feedback">Nice — that’ll help others get a feel for it.</div>
      <div class="invalid-feedback">Please write a brief review before submitting.</div>
    </div>

    <!-- Submit -->
    <button type="submit" class="btn btn-success">Add Review</button>
  </form>
</div>

<% } else { %>
<p class="text-muted">Please <a href="/login">sign in</a> to leave a review.</p>
<% } %>

<!-- ✅ REVIEWS LIST GOES HERE -->
<div class="mt-5 pt-4 border-top">
  <h5 class="mb-3">User Reviews</h5>


  <% if (!reviews || reviews.length === 0) { %>
    <p class="text-muted">No reviews yet — be the first to share your experience!</p>
  <% } else { %>
    <ul class="list-group mb-4">
      <% reviews.forEach(review => { %>
        <li class="list-group-item">
          <div class="d-flex justify-content-between">
            <h6 class="card-title"><%= review.author.username %></h6>
            <div class="starability-result" width="50%" data-rating="<%= review.rating %>"></div>


            
          </div>
          <p class="mb-0 mt-1"><%= review.body %></p>

          <% if (currentUser && currentUser._id.toString() === review.author._id.toString()) { %>
            <form action="/campgrounds/<%= campground._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST" class="mt-2">
              <button class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this review?')">
                <i class="bi bi-trash"></i> Delete
              </button>
            </form>
          <% } %>
        </li>
      <% }) %>
    </ul>

    <!-- Pagination Controls -->
    <nav aria-label="Review pagination">
      <ul class="pagination justify-content-center">
        <% for (let i = 1; i <= totalPages; i++) { %>
          <li class="page-item <%= i === currentPage ? 'active' : '' %>">
            <a class="page-link" href="?page=<%= i %>"><%= i %></a>
          </li>
        <% } %>
      </ul>
    </nav>
  <% } %>
</div>



</div> 


</div>
</div>


<!-- Mapbox JS -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<script> 

const mapToken = '<%= process.env.MAPBOX_TOKEN %>';
const campground = <%- JSON.stringify(campground.geometry.coordinates) %>;
const campTitle = '<%= campground.title %>';
const campLocation = '<%= campground.location %>';
const campDescription = '<%= campground.description %>';

</script>

<script src="/javascripts/showPageMap.js"></script>